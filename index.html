<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <style>
        :root {
            --primary-color: #0088cc;
            --secondary-color: #f8f9fa;
            --text-color: #333;
            --light-gray: #e9ebeb;
            --medium-gray: #d1d7db;
            --dark-gray: #667781;
            --online-status: #00c853;
            --offline-status: #9e9e9e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            height: 100vh;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        .sidebar {
            background-color: var(--secondary-color);
            border-right: 1px solid var(--medium-gray);
            height: 100%;
            overflow-y: auto;
        }

        .chat-header {
            background-color: var(--light-gray);
            padding: 15px;
            border-bottom: 1px solid var(--medium-gray);
        }

        .chat-messages {
            height: calc(100vh - 180px);
            overflow-y: auto;
            padding: 15px;
            background-color: #efeae2;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .message-input {
            background-color: var(--light-gray);
            padding: 15px;
            border-top: 1px solid var(--medium-gray);
        }

        .user-item,
        .group-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--medium-gray);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .user-item:hover,
        .group-item:hover {
            background-color: var(--light-gray);
        }

        .user-item.active,
        .group-item.active {
            background-color: var(--medium-gray);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .online {
            background-color: var(--online-status);
        }

        .offline {
            background-color: var(--offline-status);
        }

        .message {
            max-width: 75%;
            margin-bottom: 15px;
            clear: both;
        }

        .message-content {
            padding: 8px 12px;
            border-radius: 7.5px;
            position: relative;
        }

        .sent {
            float: right;
        }

        .sent .message-content {
            background-color: #d9fdd3;
            border-top-right-radius: 0;
        }

        .received {
            float: left;
        }

        .received .message-content {
            background-color: white;
            border-top-left-radius: 0;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--dark-gray);
            text-align: right;
            margin-top: 3px;
        }

        .typing-indicator {
            padding: 5px 15px;
            font-style: italic;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .unread-count {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-left: auto;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .chat-section {
            display: none;
        }

        .chat-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--dark-gray);
            text-align: center;
        }

        .search-results {
            position: absolute;
            background: white;
            width: calc(100% - 30px);
            margin: 0 15px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-item:hover {
            background-color: #f5f5f5;
        }

        .modal-create-group {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .close-modal {
            float: right;
            cursor: pointer;
            font-size: 24px;
        }

        .group-member-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .group-member-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
    </style>
</head>

<body>
    <!-- Login Section -->
    <div id="loginSection" class="container-fluid">
        <div class="login-container">
            <h2 class="text-center mb-4">Telegram Chat</h2>
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="Enter your email">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" placeholder="Enter your password">
            </div>
            <button id="loginBtn" class="btn btn-primary w-100 mb-3">Login</button>
            <p class="text-center">Don't have an account? <a href="#" id="showRegister">Register</a></p>

            <div id="registerForm" style="display: none;">
                <hr>
                <div class="mb-3">
                    <label for="firstName" class="form-label">First Name</label>
                    <input type="text" class="form-control" id="firstName">
                </div>
                <div class="mb-3">
                    <label for="lastName" class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="lastName">
                </div>
                <button id="registerBtn" class="btn btn-success w-100">Register</button>
                <p class="text-center mt-3"><a href="#" id="showLogin">Back to Login</a></p>
            </div>
        </div>
    </div>

    <!-- Chat Application -->
    <div id="chatSection" class="chat-section">
        <div class="container-fluid h-100">
            <div class="row h-100">
                <!-- Sidebar -->
                <div class="col-md-3 p-0 sidebar">
                    <div class="chat-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Telegram</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="newChatBtn">
                                <i class="fas fa-comment-medical"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="newGroupBtn">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-2 position-relative">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search users..." id="searchInput">
                            <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="search-results" id="searchResults">
                            <!-- Search results will appear here -->
                        </div>
                    </div>

                    <div class="nav nav-pills flex-column" id="chatsList">
                        <!-- Chats will be populated here -->
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="col-md-9 p-0 d-flex flex-column">
                    <div class="chat-header" id="currentChatHeader">
                        <div class="chat-placeholder">
                            <div>
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <h4>Welcome to Telegram Chat</h4>
                                <p>Select a chat to start messaging</p>
                            </div>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be displayed here -->
                    </div>

                    <div class="message-input">
                        <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="text" class="form-control" placeholder="Type a message..." id="messageInput">
                            <button class="btn btn-primary" type="button" id="sendMessageBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal-create-group">
        <div class="modal-content">
            <span class="close-modal" id="closeGroupModal">&times;</span>
            <h4>Create New Group</h4>
            <div class="mb-3">
                <label for="groupName" class="form-label">Group Name</label>
                <input type="text" class="form-control" id="groupName">
            </div>
            <div class="mb-3">
                <label for="groupDescription" class="form-label">Description (Optional)</label>
                <textarea class="form-control" id="groupDescription" rows="2"></textarea>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="groupIsPrivate">
                <label class="form-check-label" for="groupIsPrivate">Private Group</label>
            </div>
            <div class="mb-3">
                <label class="form-label">Add Members</label>
                <div class="group-member-list" id="groupMemberList">
                    <!-- Users will be populated here -->
                </div>
            </div>
            <button class="btn btn-primary w-100" id="createGroupBtn">Create Group</button>
        </div>
    </div>

    <script>
        // Global variables
        const APIURL = 'https://localhost:7021';
        let connection = null;
        let currentUser = null;
        let currentChat = null;
        let chatType = null; // 'private' or 'group'
        let users = [];
        let groups = [];

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const chatSection = document.getElementById('chatSection');
        const chatsList = document.getElementById('chatsList');
        const chatMessages = document.getElementById('chatMessages');
        const currentChatHeader = document.getElementById('currentChatHeader');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchResults = document.getElementById('searchResults');
        const createGroupModal = document.getElementById('createGroupModal');
        const groupMemberList = document.getElementById('groupMemberList');
        const closeGroupModal = document.getElementById('closeGroupModal');
        const createGroupBtn = document.getElementById('createGroupBtn');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            // Check if user is already logged in
            const token = localStorage.getItem('token');
            if (token) {
                // Validate token and get user info
                fetch(`${APIURL}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Invalid token');
                        }
                    })
                    .then(user => {
                        currentUser = user;
                        initializeSignalRConnection(token);
                        showChatInterface();
                        loadChats();
                    })
                    .catch(error => {
                        console.error('Authentication error:', error);
                        localStorage.removeItem('token');
                    });
            }

            // Event listeners
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            sendMessageBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Search functionality
            searchButton.addEventListener('click', searchUsers);
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    searchUsers();
                }
            });

            // Group creation
            document.getElementById('newGroupBtn').addEventListener('click', showCreateGroupModal);
            closeGroupModal.addEventListener('click', hideCreateGroupModal);
            createGroupBtn.addEventListener('click', createGroup);

            // Close search results when clicking outside
            document.addEventListener('click', function (e) {
                if (!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchButton) {
                    searchResults.style.display = 'none';
                }
            });

            messageInput.addEventListener('input', function () {
                if (!currentChat) return;

                if (chatType === 'private') {
                    connection.invoke("StartTyping", currentChat.id);
                } else if (chatType === 'group') {
                    connection.invoke("StartTyping", null, currentChat.id);
                }

                // Clear previous timeout if exists
                if (window.typingTimeout) {
                    clearTimeout(window.typingTimeout);
                }

                // Set timeout to stop typing indicator
                window.typingTimeout = setTimeout(() => {
                    if (chatType === 'private') {
                        connection.invoke("StopTyping", currentChat.id);
                    } else if (chatType === 'group') {
                        connection.invoke("StopTyping", null, currentChat.id);
                    }
                }, 1000);
            });
        });

        // Search users function
        function searchUsers() {
            const query = searchInput.value.trim();
            if (!query) {
                searchResults.style.display = 'none';
                return;
            }

            fetch(`${APIURL}/api/users/search?query=${encodeURIComponent(query)}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => response.json())
                .then(users => {
                    displaySearchResults(users);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<div class="search-item">Error searching users</div>';
                    searchResults.style.display = 'block';
                });
        }

        // Display search results
        function displaySearchResults(users) {
            searchResults.innerHTML = '';

            if (users.length === 0) {
                searchResults.innerHTML = '<div class="search-item">No users found</div>';
            } else {
                users.forEach(user => {
                    if (user.id !== currentUser.id) {
                        const userElement = document.createElement('div');
                        userElement.className = 'search-item';
                        userElement.innerHTML = `
                            <div class="d-flex align-items-center">
                                <span class="status-indicator ${user.isOnline ? 'online' : 'offline'}"></span>
                                <div class="ms-2">
                                    <strong>${user.firstName} ${user.lastName}</strong>
                                    <div class="text-muted small">${user.email}</div>
                                </div>
                            </div>
                        `;
                        userElement.addEventListener('click', () => {
                            // Check if user already exists in chat list
                            const existingUser = users.find(u => u.id === user.id);
                            if (!existingUser) {
                                // Add to users list
                                users.push(user);
                                renderChatsList();
                            }
                            // Open chat with this user
                            openChat(user, 'private');
                            // Clear search and hide results
                            searchInput.value = '';
                            searchResults.style.display = 'none';
                        });
                        searchResults.appendChild(userElement);
                    }
                });
            }

            searchResults.style.display = 'block';
        }

        // Authentication functions
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            fetch(`${APIURL}/api/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                        currentUser = data.user;
                        initializeSignalRConnection(data.token);
                        showChatInterface();
                        loadChats();
                    } else {
                        alert('Login failed: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    alert('Login failed. Please try again.');
                });
        }

        function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;

            fetch(`${APIURL}/api/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password, firstName, lastName })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                        currentUser = data.user;
                        initializeSignalRConnection(data.token);
                        showChatInterface();
                        loadChats();
                    } else {
                        alert('Registration failed: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Registration error:', error);
                    alert('Registration failed. Please try again.');
                });
        }

        function showRegisterForm() {
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('showRegister').style.display = 'none';
        }

        function showLoginForm() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('showRegister').style.display = 'block';
        }

        function showChatInterface() {
            loginSection.style.display = 'none';
            chatSection.style.display = 'block';
        }

        // SignalR Connection
        function initializeSignalRConnection(token) {
            // Create connection
            connection = new signalR.HubConnectionBuilder()
                .withUrl(`${APIURL}/chatHub`, {
                    accessTokenFactory: () => token
                })
                .withAutomaticReconnect()
                .build();

            // Define event handlers
            connection.on("ReceivePrivateMessage", receivePrivateMessage);
            connection.on("ReceiveGroupMessage", receiveGroupMessage);
            connection.on("MessageSent", messageSent);
            connection.on("MessageRead", messageRead);
            connection.on("UserStatusChanged", userStatusChanged);
            connection.on("UserTyping", userTyping);
            connection.on("UserTypingInGroup", userTypingInGroup);
            connection.on("JoinedGroup", joinedGroup);
            connection.on("LeftGroup", leftGroup);
            connection.on("Error", showError);

            // Start connection
            connection.start()
                .then(() => {
                    console.log("SignalR Connected");
                })
                .catch(err => console.error('SignalR Connection Error: ', err));
        }

        // Load chats (users and groups)
        function loadChats() {
            // Load users
            fetch(`${APIURL}/api/users/online`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => response.json())
                .then(onlineUsers => {
                    users = onlineUsers;
                    renderChatsList();
                })
                .catch(error => console.error('Error loading users:', error));

            // Load groups
            fetch(`${APIURL}/api/groups`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => response.json())
                .then(userGroups => {
                    groups = userGroups;
                    renderChatsList();
                })
                .catch(error => console.error('Error loading groups:', error));
        }

        // Render chats list
        function renderChatsList() {
            chatsList.innerHTML = '';

            // Add users
            users.forEach(user => {
                if (user.id !== currentUser.id) {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.dataset.id = user.id;
                    userItem.dataset.type = 'private';
                    userItem.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="status-indicator ${user.isOnline ? 'online' : 'offline'}"></span>
                            <div class="ms-2">
                                <strong>${user.firstName} ${user.lastName}</strong>
                                <div class="text-muted small">${user.isOnline ? 'Online' : 'Last seen ' + formatTime(user.lastSeen)}</div>
                            </div>
                            <span class="unread-count ms-auto" style="display: none;">0</span>
                        </div>
                    `;
                    userItem.addEventListener('click', () => openChat(user, 'private'));
                    chatsList.appendChild(userItem);
                }
            });

            // Add groups
            groups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.dataset.id = group.id;
                groupItem.dataset.type = 'group';
                groupItem.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users me-2"></i>
                        <div>
                            <strong>${group.name}</strong>
                            <div class="text-muted small">${group.members.length} members</div>
                        </div>
                        <span class="unread-count ms-auto" style="display: none;">0</span>
                    </div>
                `;
                groupItem.addEventListener('click', () => openChat(group, 'group'));
                chatsList.appendChild(groupItem);
            });
        }

        // Open chat with user or group
        function openChat(chat, type) {
            currentChat = chat;
            chatType = type;

            // Update UI
            document.querySelectorAll('.user-item, .group-item').forEach(item => {
                item.classList.remove('active');
            });

            const activeItem = document.querySelector(`[data-id="${chat.id}"][data-type="${type}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            // Update header
            if (type === 'private') {
                currentChatHeader.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="status-indicator ${chat.isOnline ? 'online' : 'offline'} me-2"></span>
                        <div>
                            <h6 class="mb-0">${chat.firstName} ${chat.lastName}</h6>
                            <small class="text-muted">${chat.isOnline ? 'Online' : 'Last seen ' + formatTime(chat.lastSeen)}</small>
                        </div>
                    </div>
                `;
            } else {
                currentChatHeader.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users me-2"></i>
                        <div>
                            <h6 class="mb-0">${chat.name}</h6>
                            <small class="text-muted">${chat.members.length} members</small>
                        </div>
                    </div>
                `;
            }

            // Load messages
            loadMessages();
        }

        // Load messages for current chat
        function loadMessages() {
            chatMessages.innerHTML = '';

            if (chatType === 'private') {
                fetch(`${APIURL}/api/messages/private/${currentChat.id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                })
                    .then(response => response.json())
                    .then(messages => {
                        displayMessages(messages);
                    })
                    .catch(error => console.error('Error loading messages:', error));
            } else {
                fetch(`${APIURL}/api/messages/group/${currentChat.id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                })
                    .then(response => response.json())
                    .then(messages => {
                        displayMessages(messages);
                    })
                    .catch(error => console.error('Error loading messages:', error));
            }
        }

        // Display messages in chat area
        function displayMessages(messages) {
            messages.forEach(message => {
                addMessageToChat(message);
            });

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add a single message to chat
        function addMessageToChat(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.senderId === currentUser.id ? 'sent' : 'received'}`;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            if (message.type === 'Text') {
                messageContent.textContent = message.content;
            } else {
                // Handle different message types (image, file, etc.)
                messageContent.innerHTML = `
                    <div><i class="fas fa-file"></i> ${message.content}</div>
                    <a href="${message.attachmentUrl}" target="_blank">Download</a>
                `;
            }

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = formatTime(message.sentAt);

            messageElement.appendChild(messageContent);
            messageElement.appendChild(messageTime);
            chatMessages.appendChild(messageElement);

            // Mark as read if it's a received message
            if (message.senderId !== currentUser.id && !message.isRead) {
                connection.invoke("MarkMessageAsRead", message.id);
            }
        }

        // Send message
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentChat) return;

            if (chatType === 'private') {
                connection.invoke("SendPrivateMessage", currentChat.id, content, 0, null)
                    .catch(err => console.error('Error sending message:', err));
            } else {
                connection.invoke("SendGroupMessage", currentChat.id, content, 0, null)
                    .catch(err => console.error('Error sending message:', err));
            }

            messageInput.value = '';
        }

        // SignalR Event Handlers
        function receivePrivateMessage(message) {
            if (currentChat && chatType === 'private' && currentChat.id === message.senderId) {
                addMessageToChat(message);
            } else {
                // Show notification or update unread count
                updateUnreadCount(message.senderId, 'private');
            }
        }

        function receiveGroupMessage(message) {
            if (currentChat && chatType === 'group' && currentChat.id === message.groupId) {
                addMessageToChat(message);
            } else {
                // Show notification or update unread count
                updateUnreadCount(message.groupId, 'group');
            }
        }

        function messageSent(message) {
            // Message was successfully sent, add to UI
            if ((chatType === 'private' && currentChat.id === message.receiverId) ||
                (chatType === 'group' && currentChat.id === message.groupId)) {
                addMessageToChat(message);
            }
        }

        function messageRead(messageId, userId) {
            // Update message read status in UI
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.querySelector('.message-status').innerHTML = '<i class="fas fa-check-double text-info"></i>';
            }
        }

        function userStatusChanged(userId, isOnline) {
            // Update user status in chats list
            const userItem = document.querySelector(`.user-item[data-id="${userId}"]`);
            if (userItem) {
                const indicator = userItem.querySelector('.status-indicator');
                const statusText = userItem.querySelector('.text-muted');

                indicator.className = `status-indicator ${isOnline ? 'online' : 'offline'}`;
                statusText.textContent = isOnline ? 'Online' : 'Last seen ' + formatTime(new Date());
            }

            // Update status in chat header if this is the current chat
            if (currentChat && chatType === 'private' && currentChat.id === userId) {
                const headerIndicator = currentChatHeader.querySelector('.status-indicator');
                const headerStatus = currentChatHeader.querySelector('.text-muted');

                headerIndicator.className = `status-indicator ${isOnline ? 'online' : 'offline'} me-2`;
                headerStatus.textContent = isOnline ? 'Online' : 'Last seen ' + formatTime(new Date());
            }
        }

        function userTyping(userId, userName, isTyping) {
            if (currentChat && chatType === 'private' && currentChat.id === userId) {
                if (isTyping) {
                    typingIndicator.textContent = `${userName} is typing...`;
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            }
        }

        function userTypingInGroup(groupId, userId, userName, isTyping) {
            if (currentChat && chatType === 'group' && currentChat.id === groupId && userId !== currentUser.id) {
                if (isTyping) {
                    typingIndicator.textContent = `${userName} is typing...`;
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            }
        }

        function joinedGroup(groupId) {
            console.log(`Joined group: ${groupId}`);
        }

        function leftGroup(groupId) {
            console.log(`Left group: ${groupId}`);
        }

        function showError(message) {
            console.error('Error from server:', message);
            alert(`Error: ${message}`);
        }

        // Helper functions
        function formatTime(dateTime) {
            const date = new Date(dateTime);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function updateUnreadCount(id, type) {
            const item = document.querySelector(`[data-id="${id}"][data-type="${type}"]`);
            if (item) {
                let unreadCount = item.querySelector('.unread-count');
                if (!unreadCount) {
                    unreadCount = document.createElement('span');
                    unreadCount.className = 'unread-count ms-auto';
                    item.querySelector('.d-flex').appendChild(unreadCount);
                }

                const currentCount = parseInt(unreadCount.textContent || '0');
                unreadCount.textContent = currentCount + 1;
                unreadCount.style.display = 'flex';
            }
        }

        // Group creation functions
        function showCreateGroupModal() {
            // Load users for group creation
            fetch(`${APIURL}/api/users/online`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => response.json())
                .then(users => {
                    groupMemberList.innerHTML = '';
                    users.forEach(user => {
                        if (user.id !== currentUser.id) {
                            const memberItem = document.createElement('div');
                            memberItem.className = 'group-member-item';
                            memberItem.innerHTML = `
                                <input type="checkbox" class="form-check-input me-2" value="${user.id}" id="member-${user.id}">
                                <label class="form-check-label" for="member-${user.id}">
                                    ${user.firstName} ${user.lastName}
                                </label>
                            `;
                            groupMemberList.appendChild(memberItem);
                        }
                    });
                    createGroupModal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading users for group:', error);
                    alert('Failed to load users for group creation');
                });
        }

        function hideCreateGroupModal() {
            createGroupModal.style.display = 'none';
        }

        function createGroup() {
            const groupName = document.getElementById('groupName').value;
            const groupDescription = document.getElementById('groupDescription').value;
            const isPrivate = document.getElementById('groupIsPrivate').checked;

            if (!groupName) {
                alert('Group name is required');
                return;
            }

            // Get selected members
            const selectedMembers = [];
            document.querySelectorAll('#groupMemberList input:checked').forEach(checkbox => {
                selectedMembers.push(checkbox.value);
            });

            const groupData = {
                name: groupName,
                description: groupDescription,
                isPrivate: isPrivate,
                memberIds: selectedMembers
            };

            fetch(`${APIURL}/api/groups`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(groupData)
            })
                .then(response => response.json())
                .then(group => {
                    // Add the new group to the list
                    groups.push(group);
                    renderChatsList();
                    hideCreateGroupModal();
                    // Open the new group
                    openChat(group, 'group');
                })
                .catch(error => {
                    console.error('Error creating group:', error);
                    alert('Failed to create group');
                });
        }
    </script>
</body>

</html>